<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAP-Kartei · Luxemburg · Cat. A/B</title>
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--txt:#0f172a;--muted:#64748b;--line:#e2e8f0;--primary:#0ea5e9;--danger:#ef4444;--ok:#16a34a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-size:22px} .sub{color:var(--muted);margin-bottom:18px}
    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:2fr 1fr 1fr}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
    .card.pad{padding:14px}
    label{display:block;font-weight:600;margin-bottom:4px}
    input,select,textarea,button{font:inherit}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    textarea{resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .entry{padding:12px}
    .entry h3{margin:0 0 6px;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{color:var(--muted);font-size:12px;margin-bottom:8px}
    .pill{display:inline-block;border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px;background:#f8fafc}
    .muted{color:var(--muted)}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .hidden{display:none}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:.98}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div>
        <h1>DAP‑Kartei (Luxemburg) – Cat. A/B</h1>
        <div class="sub">Nur für Lehrkräfte · Minimal: Beruf, Kontakt, Adresse · lokal gespeichert</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnExport">Export</button>
        <label class="btn" for="fileImport">Import<input id="fileImport" type="file" accept="application/json" class="hidden"></label>
        <button class="btn primary" id="btnNew">Neuer Betrieb</button>
      </div>
    </div>

    <!-- Filter -->
    <div class="card pad" style="margin-top:12px">
      <div class="row cols-3">
        <div>
          <label>Suchen</label>
          <input id="q" placeholder="Betrieb, Beruf, Adresse, Kontakt">
        </div>
        <div>
          <label>Beruf</label>
          <select id="fBeruf"><option value="">Alle</option></select>
        </div>
        <div>
          <label>Catégorie</label>
          <select id="fCat"><option value="">Alle</option><option>A</option><option>B</option></select>
        </div>
      </div>
    </div>

    <!-- Liste -->
    <div class="grid" id="list" style="margin-top:12px"></div>

    <!-- Dialog -->
    <div id="dialog" class="card pad hidden" style="position:fixed;inset:0;max-width:560px;margin:auto;z-index:5">
      <div class="bar">
        <strong id="dlgTitle">Neuer Betrieb</strong>
        <div class="toolbar"><button class="btn" id="dlgCancel">Schließen</button></div>
      </div>
      <div class="hr"></div>
      <div class="row cols-2">
        <div class="col-span-2">
          <label>Betrieb *</label>
          <input id="iBetrieb" />
        </div>
        <div>
          <label>Beruf (DAP) *</label>
          <input id="iBeruf" list="dlBerufe" placeholder="z. B. Schreiner/in" />
          <datalist id="dlBerufe"></datalist>
        </div>
        <div>
          <label>Catégorie *</label>
          <select id="iCat"><option>A</option><option>B</option></select>
        </div>
        <div class="col-span-2">
          <label>Adresse *</label>
          <textarea id="iAdresse" rows="2" placeholder="Straße, PLZ Ort"></textarea>
        </div>
        <div class="col-span-2">
          <label>Kontakt *</label>
          <textarea id="iKontakt" rows="2" placeholder="Name, Telefon, E‑Mail"></textarea>
        </div>
      </div>
      <div class="hr"></div>
      <div class="bar">
        <span class="muted small">Nur DAP Cat. A/B</span>
        <div class="toolbar">
          <button class="btn danger" id="dlgDelete" title="Eintrag löschen">Löschen</button>
          <button class="btn primary" id="dlgSave">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
  (function(){
    const LS_KEY = 'dap_kartei_lu_catAB_v1';
    const state = load();
    const els = {
      list: document.getElementById('list'),
      q: document.getElementById('q'),
      fBeruf: document.getElementById('fBeruf'),
      fCat: document.getElementById('fCat'),
      btnNew: document.getElementById('btnNew'),
      btnExport: document.getElementById('btnExport'),
      fileImport: document.getElementById('fileImport'),
      dlg: document.getElementById('dialog'),
      dlgTitle: document.getElementById('dlgTitle'),
      iBetrieb: document.getElementById('iBetrieb'),
      iBeruf: document.getElementById('iBeruf'),
      iCat: document.getElementById('iCat'),
      iAdresse: document.getElementById('iAdresse'),
      iKontakt: document.getElementById('iKontakt'),
      dlgSave: document.getElementById('dlgSave'),
      dlgCancel: document.getElementById('dlgCancel'),
      dlgDelete: document.getElementById('dlgDelete'),
      dlBerufe: document.getElementById('dlBerufe'),
      toast: document.getElementById('toast'),
    };

    if(state.entries.length === 0){
      state.entries.push(
        {id:uid(), betrieb:'Holzkunst Wagner', beruf:'Schreiner/in', categorie:'A', adresse:"Rue de l'Atelier 12, 9001 Ettelbruck", kontakt:'Jean Wagner – +352 2456 7890 – info@holzkunst-wagner.lu'},
        {id:uid(), betrieb:'Boulangerie du Parc', beruf:'Bäcker/in', categorie:'B', adresse:'Avenue du Parc 3, 1000 Luxembourg', kontakt:'Mina Pereira – +352 2211 3344 – contact@boulangerieduparc.lu'}
      );
      save();
    }

    els.q.addEventListener('input', render);
    els.fBeruf.addEventListener('change', render);
    els.fCat.addEventListener('change', render);
    els.btnNew.addEventListener('click', ()=> openDialog());
    els.btnExport.addEventListener('click', onExport);
    els.fileImport.addEventListener('change', onImport);
    els.dlgCancel.addEventListener('click', closeDialog);
    els.dlgSave.addEventListener('click', saveEntry);
    els.dlgDelete.addEventListener('click', deleteEntry);

    function uid(){ return Math.random().toString(36).slice(2,10) }

    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {entries:[], berufe:[]} }catch{ return {entries:[], berufe:[]} }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function toast(msg){
      els.toast.textContent = msg; els.toast.classList.remove('hidden');
      setTimeout(()=> els.toast.classList.add('hidden'), 2200);
    }

    function onExport(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'dap_kartei_export.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function onImport(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      file.text().then(txt=>{
        try{ const json = JSON.parse(txt); if(!Array.isArray(json.entries)) throw 0; 
          state.entries = json.entries; state.berufe = json.berufe || []; save(); hydrateFilters(); render(); toast('Import erfolgreich');
        }catch{ toast('Import fehlgeschlagen'); }
      }).finally(()=> e.target.value = '');
    }

    let editingId = null;
    function openDialog(entry){
      editingId = entry?.id || null;
      els.dlgTitle.textContent = editingId ? 'Eintrag bearbeiten' : 'Neuer Betrieb';
      els.iBetrieb.value = entry?.betrieb || '';
      els.iBeruf.value = entry?.beruf || '';
      els.iCat.value = entry?.categorie || 'A';
      els.iAdresse.value = entry?.adresse || '';
      els.iKontakt.value = entry?.kontakt || '';
      els.dlgDelete.style.display = editingId ? 'inline-flex' : 'none';
      els.dlg.classList.remove('hidden');
    }
    function closeDialog(){ els.dlg.classList.add('hidden'); }

    function saveEntry(){
      const item = {
        id: editingId || uid(),
        betrieb: els.iBetrieb.value.trim(),
        beruf: els.iBeruf.value.trim(),
        categorie: els.iCat.value,
        adresse: els.iAdresse.value.trim(),
        kontakt: els.iKontakt.value.trim(),
      };
      if(!item.betrieb || !item.beruf || !item.categorie || !item.adresse || !item.kontakt){ return toast('Bitte alle Pflichtfelder ausfüllen'); }
      if(!['A','B'].includes(item.categorie)) return toast('Nur Catégorie A oder B erlaubt');

      const idx = state.entries.findIndex(e=> e.id===item.id);
      if(idx>=0) state.entries[idx]=item; else state.entries.unshift(item);
      if(item.beruf && !state.berufe.includes(item.beruf)) state.berufe.push(item.beruf);
      state.berufe.sort((a,b)=>a.localeCompare(b,'de'));
      save(); hydrateFilters(); render(); closeDialog(); toast('Gespeichert');
    }

    function deleteEntry(){
      if(!editingId) return; 
      state.entries = state.entries.filter(e=> e.id!==editingId);
      save(); render(); closeDialog(); toast('Gelöscht');
    }

    function hydrateFilters(){
      const all = Array.from(new Set(state.berufe.concat(state.entries.map(e=>e.beruf)))).filter(Boolean).sort((a,b)=>a.localeCompare(b,'de'));
      els.fBeruf.innerHTML = '<option value="">Alle</option>' + all.map(b=>`<option>${b}</option>`).join('');
      els.dlBerufe.innerHTML = all.map(b=>`<option value="${b}">`).join('');
    }

    function render(){
      const q = els.q.value.trim().toLowerCase();
      const fB = els.fBeruf.value; const fC = els.fCat.value;
      const list = state.entries.filter(e=>{
        const qOK = q ? [e.betrieb,e.beruf,e.adresse,e.kontakt].filter(Boolean).some(v=>v.toLowerCase().includes(q)) : true;
        const bOK = fB ? e.beruf===fB : true; const cOK = fC ? e.categorie===fC : true;
        return qOK && bOK && cOK;
      });

      els.list.innerHTML = list.map(e=> `
        <div class="card entry">
          <h3 title="${esc(e.betrieb)}">${esc(e.betrieb)}</h3>
          <div class="meta">${esc(e.beruf)} · <span class="pill">Cat. ${esc(e.categorie)}</span></div>
          <div class="small"><strong>Adresse:</strong> ${esc(e.adresse)}</div>
          <div class="small" style="margin-top:4px"><strong>Kontakt:</strong> ${esc(e.kontakt)}</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btnEdit" data-id="${e.id}">Bearbeiten</button>
            <button class="btn danger btnDel" data-id="${e.id}">Löschen</button>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.btnEdit').forEach(b=> b.addEventListener('click', ev=>{
        const id = ev.currentTarget.getAttribute('data-id');
        const entry = state.entries.find(x=>x.id===id); openDialog(entry);
      }));
      document.querySelectorAll('.btnDel').forEach(b=> b.addEventListener('click', ev=>{
        const id = ev.currentTarget.getAttribute('data-id');
        state.entries = state.entries.filter(x=>x.id!==id); save(); render(); toast('Gelöscht');
      }));
    }

    function esc(s){ return String(s||'').replace(/[&<>\"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])) }

    hydrateFilters(); render();
  })();
  </script>
</body>
</html>

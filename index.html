<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patrons de stage</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#ffffff;--txt:#0f172a;--muted:#5b6477;--line:#e6ebf2;
      --primary:#2563eb;--primary-600:#1e40af;--accent:#22c55e;--danger:#ef4444;
      --grad1:#eef2ff;--grad2:#f0f9ff
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--grad1),var(--grad2));color:var(--txt);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{background:linear-gradient(90deg,#3b82f6,#2563eb);color:#fff}
    header .inner{max-width:1100px;margin:0 auto;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{opacity:.9;font-size:12.5px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid transparent;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:#fff;color:#0f172a;border-color:#ffffff20}
    .btn.ghost{background:transparent;color:#fff;border-color:#ffffff40}
    .btn.danger{background:var(--danger);color:#fff}

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 24px rgba(15,23,42,.06)}
    .card.pad{padding:16px}

    label{display:block;font-weight:600;margin-bottom:6px;color:#0f172a}
    input,select,textarea,button{font:inherit}
    input,select,textarea{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
    textarea{resize:vertical}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
    .entry{padding:14px}
    .entry h3{margin:0 0 6px;font-size:17px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{color:var(--muted);font-size:12.5px;margin-bottom:8px}
    .pill{display:inline-block;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;background:#f8fafc}

    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:2fr 1fr 1fr}
    .row.cols-2{grid-template-columns:1fr 1fr}

    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .hidden{display:none}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:.98}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:var(--muted)}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid #e0e7ff;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div style="display:flex;align-items:center;gap:14px">
        <img src="fieldgen-logo.png" alt="Fieldgen Logo" style="height:50px">
        <div>
          <h1>Patrons de stage</h1>
          <div class="sub">Schnelle Übersicht für Lehrkräfte – Suche, Filter, Import/Export</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="btnExport">Export</button>
        <label class="btn ghost" for="fileImport">Import<input id="fileImport" type="file" accept="application/json" class="hidden"></label>
        <button class="btn primary" id="btnNew">Neuer Betrieb</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Filter -->
    <div class="card pad" style="margin-top:16px">
      <div class="row cols-3">
        <div>
          <label>Suchen</label>
          <input id="q" placeholder="Betrieb, Beruf, Adresse, Kontakt, Remarque">
        </div>
        <div>
          <label>Beruf</label>
          <select id="fBeruf"><option value="">Alle</option></select>
        </div>
        <div>
          <label class="small">&nbsp;</label>
          <div class="badge">Kein Kategorien‑Filter</div>
        </div>
      </div>
    </div>

    <!-- Liste -->
    <div class="grid" id="list" style="margin-top:14px"></div>

    <!-- Dialog -->
    <div id="dialog" class="card pad hidden" style="position:fixed;inset:0;max-width:620px;margin:auto;z-index:5">
      <div class="bar">
        <strong id="dlgTitle">Neuer Betrieb</strong>
        <div class="toolbar"><button class="btn" id="dlgCancel">Schließen</button></div>
      </div>
      <div class="hr"></div>
      <div class="row cols-2">
        <div class="col-span-2">
          <label>Betrieb *</label>
          <input id="iBetrieb" />
        </div>
        <div>
          <label>Beruf *</label>
          <input id="iBeruf" list="dlBerufe" placeholder="z. B. Schreiner/in" />
          <datalist id="dlBerufe"></datalist>
        </div>
        <div>
          <label>Adresse *</label>
          <textarea id="iAdresse" rows="2" placeholder="Straße, PLZ Ort"></textarea>
        </div>
        <div class="col-span-2">
          <label>Kontakt *</label>
          <textarea id="iKontakt" rows="2" placeholder="Name, Telefon, E‑Mail"></textarea>
        </div>
        <div class="col-span-2">
          <label>Remarque</label>
          <textarea id="iRemarque" rows="2" placeholder="Bemerkungen / Hinweise"></textarea>
        </div>
      </div>
      <div class="hr"></div>
      <div class="bar">
        <span class="small">Löschen erfordert einen Code.</span>
        <div class="toolbar">
          <button class="btn danger" id="dlgDelete" title="Eintrag löschen">Löschen</button>
          <button class="btn primary" id="dlgSave">Speichern</button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast hidden"></div>

  <script>
  (function(){
    const LS_KEY = 'patrons_stage_v2';
    const state = load();
    const DELETE_CODE = '1130';

    const els = {
      list: document.getElementById('list'),
      q: document.getElementById('q'),
      fBeruf: document.getElementById('fBeruf'),
      btnNew: document.getElementById('btnNew'),
      btnExport: document.getElementById('btnExport'),
      fileImport: document.getElementById('fileImport'),
      dlg: document.getElementById('dialog'),
      dlgTitle: document.getElementById('dlgTitle'),
      iBetrieb: document.getElementById('iBetrieb'),
      iBeruf: document.getElementById('iBeruf'),
      iAdresse: document.getElementById('iAdresse'),
      iKontakt: document.getElementById('iKontakt'),
      iRemarque: document.getElementById('iRemarque'),
      dlgSave: document.getElementById('dlgSave'),
      dlgCancel: document.getElementById('dlgCancel'),
      dlgDelete: document.getElementById('dlgDelete'),
      dlBerufe: document.getElementById('dlBerufe'),
      toast: document.getElementById('toast'),
    };

    if(state.entries.length === 0){
      state.entries.push(
        {id:uid(), betrieb:'Holzkunst Wagner', beruf:'Schreiner/in', adresse:"Rue de l'Atelier 12, 9001 Ettelbruck", kontakt:'Jean Wagner – +352 2456 7890 – info@holzkunst-wagner.lu', remarque:'Gute Betreuung'},
        {id:uid(), betrieb:'Boulangerie du Parc', beruf:'Bäcker/in', adresse:'Avenue du Parc 3, 1000 Luxembourg', kontakt:'Mina Pereira – +352 2211 3344 – contact@boulangerieduparc.lu', remarque:'Früher Beginn'}
      );
      save();
    }

    // Events
    els.q.addEventListener('input', render);
    els.fBeruf.addEventListener('change', render);
    els.btnNew.addEventListener('click', ()=> openDialog());
    els.btnExport.addEventListener('click', onExport);
    els.fileImport.addEventListener('change', onImport);
    els.dlgCancel.addEventListener('click', closeDialog);
    els.dlgSave.addEventListener('click', saveEntry);
    els.dlgDelete.addEventListener('click', deleteEntry);

    function uid(){ return Math.random().toString(36).slice(2,10) }

    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {entries:[], berufe:[]} }catch{ return {entries:[], berufe:[]} }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function toast(msg){
      els.toast.textContent = msg; els.toast.classList.remove('hidden');
      setTimeout(()=> els.toast.classList.add('hidden'), 2200);
    }

    function onExport(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'patrons_de_stage.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function onImport(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      file.text().then(txt=>{
        try{ const json = JSON.parse(txt); if(!Array.isArray(json.entries)) throw 0; 
          state.entries = json.entries; state.berufe = json.berufe || []; save(); hydrateFilters(); render(); toast('Import erfolgreich');
        }catch{ toast('Import fehlgeschlagen'); }
      }).finally(()=> e.target.value = '');
    }

    let editingId = null;
    function openDialog(entry){
      editingId = entry?.id || null;
      els.dlgTitle.textContent = editingId ? 'Eintrag bearbeiten' : 'Neuer Betrieb';
      els.iBetrieb.value = entry?.betrieb || '';
      els.iBeruf.value = entry?.beruf || '';
      els.iAdresse.value = entry?.adresse || '';
      els.iKontakt.value = entry?.kontakt || '';
      els.iRemarque.value = entry?.remarque || '';
      els.dlgDelete.style.display = editingId ? 'inline-flex' : 'none';
      els.dlg.classList.remove('hidden');
    }
    function closeDialog(){ els.dlg.classList.add('hidden'); }

    function saveEntry(){
      const item = {
        id: editingId || uid(),
        betrieb: els.iBetrieb.value.trim(),
        beruf: els.iBeruf.value.trim(),
        adresse: els.iAdresse.value.trim(),
        kontakt: els.iKontakt.value.trim(),
        remarque: els.iRemarque.value.trim(),
      };
      if(!item.betrieb || !item.beruf || !item.adresse || !item.kontakt){ return toast('Bitte Betrieb, Beruf, Adresse und Kontakt ausfüllen'); }

      const idx = state.entries.findIndex(e=> e.id===item.id);
      if(idx>=0) state.entries[idx]=item; else state.entries.unshift(item);
      if(item.beruf && !state.berufe.includes(item.beruf)) state.berufe.push(item.beruf);
      state.berufe.sort((a,b)=>a.localeCompare(b,'de'));
      save(); hydrateFilters(); render(); closeDialog(); toast('Gespeichert');
    }

    function requireCode(){
      const entered = prompt('Bitte Code eingeben, um zu löschen:');
      if(entered === null) return false;
      if(entered !== DELETE_CODE){ toast('Falscher Code'); return false; }
      return true;
    }

    function deleteEntry(){
      if(!editingId) return; 
      if(!requireCode()) return;
      state.entries = state.entries.filter(e=> e.id!==editingId);
      save(); render(); closeDialog(); toast('Gelöscht');
    }

    function hydrateFilters(){
      const all = Array.from(new Set(state.berufe.concat(state.entries.map(e=>e.beruf)))).filter(Boolean).sort((a,b)=>a.localeCompare(b,'de'));
      els.fBeruf.innerHTML = '<option value="">Alle</option>' + all.map(b=>`<option>${b}</option>`).join('');
      els.dlBerufe.innerHTML = all.map(b=>`<option value="${b}">`).join('');
    }

    function render(){
      const q = els.q.value.trim().toLowerCase();
      const fB = els.fBeruf.value;
      const list = state.entries.filter(e=>{
        const qOK = q ? [e.betrieb,e.beruf,e.adresse,e.kontakt,e.remarque].filter(Boolean).some(v=>v.toLowerCase().includes(q)) : true;
        const bOK = fB ? e.beruf===fB : true;
        return qOK && bOK;
      });

      els.list.innerHTML = list.map(e=> `
        <div class="card entry">
          <h3 title="${esc(e.betrieb)}">${esc(e.betrieb)}</h3>
          <div class="meta">${esc(e.beruf)}</div>
          <div class="small"><strong>Adresse:</strong> ${esc(e.adresse)}</div>
          <div class="small" style="margin-top:4px"><strong>Kontakt:</strong> ${esc(e.kontakt)}</div>
          ${e.remarque ? `<div class="small" style="margin-top:4px"><strong>Remarque:</strong> ${esc(e.remarque)}</div>` : ''}
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" data-edit="${e.id}">Bearbeiten</button>
            <button class="btn danger" data-del="${e.id}">Löschen</button>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ev=>{
        const id = ev.currentTarget.getAttribute('data-edit');
        const entry = state.entries.find(x=>x.id===id); openDialog(entry);
      }));
      document.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ev=>{
        const id = ev.currentTarget.getAttribute('data-del');
        if(!requireCode()) return;
        state.entries = state.entries.filter(x=>x.id!==id); save(); render(); toast('Gelöscht');
      }));
